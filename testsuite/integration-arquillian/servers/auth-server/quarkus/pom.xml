<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <parent>
    <groupId>org.keycloak.testsuite</groupId>
    <artifactId>integration-arquillian-servers-auth-server</artifactId>
    <version>999.0.0-SNAPSHOT</version>
  </parent>
  <artifactId>integration-arquillian-servers-auth-server-quarkus</artifactId>

  <name>Auth Server - Quarkus</name>

  <properties>
    <auth.server.home>${project.build.directory}/unpacked/${dist.archive.dir}</auth.server.home>
    <common.resources>${basedir}/../common</common.resources>
    <session.cache.owners>2</session.cache.owners>
    <offline.session.cache.owners>2</offline.session.cache.owners>
    <login.failure.cache.owners>2</login.failure.cache.owners>
    <auth.server.quarkus.cluster.config>local</auth.server.quarkus.cluster.config>
    <!-- Path to testsuite/test resources : Themes-->
    <keycloak.base.test.resource>${project.parent.basedir}/../../tests/base/src/test/resources</keycloak.base.test.resource>
    <auth.server.fips.mode>disabled</auth.server.fips.mode>
  </properties>

  <dependencies>
    <dependency>
      <groupId>org.keycloak</groupId>
      <artifactId>keycloak-quarkus-dist</artifactId>
      <type>zip</type>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <artifactId>maven-resources-plugin</artifactId>
        <executions>
          <execution>
            <id>copy-content</id>
            <goals>
              <goal>copy-resources</goal>
            </goals>
            <phase>process-resources</phase>
            <configuration>
              <outputDirectory>${auth.server.home}</outputDirectory>
              <resources>
                <resource>
                  <directory>src/main/content</directory>
                  <includes>
                    <include>**</include>
                  </includes>
                </resource>
              </resources>
              <overwrite>true</overwrite>
            </configuration>
          </execution>
          <execution>
            <id>copy-pki-root</id>
            <goals>
              <goal>copy-resources</goal>
            </goals>
            <phase>process-resources</phase>
            <configuration>
              <outputDirectory>${auth.server.home}/conf</outputDirectory>
              <resources>
                <resource>
                  <directory>${common.resources}/keystore</directory>
                  <includes>
                    <include>ca.crt</include>
                    <include>client.crt</include>
                    <include>client.key</include>
                    <include>client.p12</include>
                    <include>client-ca.crt</include>
                    <include>client-ca.key</include>
                    <include>*.crl</include>
                  </includes>
                </resource>
                <resource>
                  <directory>${common.resources}/pki/root/ca</directory>
                  <includes>
                    <include>certs/clients/test-user-san@localhost.cert.pem</include>
                    <include>certs/clients/test-user-san@localhost.p12</include>
                    <include>certs/clients/test-user@localhost.key.pem</include>
                    <include>certs/clients/test-user-san-cert-test-user-key@localhost.p12</include>
                  </includes>
                </resource>
              </resources>
              <overwrite>true</overwrite>
            </configuration>
          </execution>
          <execution>
            <id>copy-pki-conf</id>
            <goals>
              <goal>copy-resources</goal>
            </goals>
            <phase>process-resources</phase>
            <configuration>
              <outputDirectory>${auth.server.home}/conf</outputDirectory>
              <resources>
                <resource>
                  <directory>${common.resources}/keystore</directory>
                  <includes>
                    <include>keycloak.jks</include>
                    <include>keycloak.truststore</include>
                    <include>client.jks</include>
                    <include>client-ca.jks</include>
                    <include>test-user-cert-intermediary-ca.jks</include>
                    <include>ca.crt</include>
                    <include>client.crt</include>
                    <include>client.key</include>
                    <include>*.crl</include>
                    <include>other_client.jks</include>
                    <include>test-user-obb.jks</include>
                  </includes>
                </resource>
              </resources>
              <overwrite>true</overwrite>
            </configuration>
          </execution>
          <execution>
            <id>copy-vault-secrets</id>
            <goals>
              <goal>copy-resources</goal>
            </goals>
            <phase>process-resources</phase>
            <configuration>
              <outputDirectory>${auth.server.home}/secrets</outputDirectory>
              <resources>
                <resource>
                  <directory>${common.resources}/vault</directory>
                  <includes>
                    <include>**</include>
                  </includes>
                </resource>
              </resources>
              <overwrite>true</overwrite>
            </configuration>
          </execution>
          <execution>
            <id>add-extending-theme</id>
            <goals>
              <goal>copy-resources</goal>
            </goals>
            <phase>process-resources</phase>
            <configuration>
              <outputDirectory>${auth.server.home}/themes</outputDirectory>
              <resources>
                <resource>
                  <directory>${keycloak.base.test.resource}/theme</directory>
                </resource>
              </resources>
            </configuration>
          </execution>
          <execution>
            <id>add-pw-blacklist-file</id>
            <goals>
              <goal>copy-resources</goal>
            </goals>
            <phase>process-resources</phase>
            <configuration>
              <outputDirectory>${auth.server.home}/dependency/password-blacklists</outputDirectory>
              <resources>
                <resource>
                  <directory>${keycloak.base.test.resource}/password-blacklists</directory>
                </resource>
              </resources>
            </configuration>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <artifactId>maven-dependency-plugin</artifactId>
        <executions>
          <execution>
            <id>unpack-server-or-overlay</id>
            <goals>
              <goal>unpack</goal>
            </goals>
            <phase>generate-resources</phase>
            <configuration>
              <artifactItems>
                <artifactItem>
                  <groupId>org.keycloak</groupId>
                  <artifactId>keycloak-quarkus-dist</artifactId>
                  <version>${project.version}</version>
                  <type>zip</type>
                  <outputDirectory>${project.build.directory}/unpacked</outputDirectory>
                </artifactItem>
              </artifactItems>
            </configuration>
          </execution>
          <execution>
            <id>includeOracleJdbcDriver</id>
            <goals>
              <goal>copy</goal>
            </goals>
            <phase>generate-resources</phase>
            <configuration>
              <artifactItems>
                <artifactItem>
                  <groupId>com.oracle.database.jdbc</groupId>
                  <artifactId>ojdbc17</artifactId>
                  <version>${oracle-jdbc.version}</version>
                  <type>jar</type>
                  <outputDirectory>${auth.server.home}/providers</outputDirectory>
                </artifactItem>
                <artifactItem>
                  <groupId>com.oracle.database.nls</groupId>
                  <artifactId>orai18n</artifactId>
                  <version>${oracle-jdbc.version}</version>
                  <type>jar</type>
                  <outputDirectory>${auth.server.home}/providers</outputDirectory>
                </artifactItem>
              </artifactItems>
            </configuration>
          </execution>
          <execution>
            <id>copy-testsuite-providers</id>
            <goals>
              <goal>copy</goal>
            </goals>
            <phase>generate-resources</phase>
            <configuration>
              <artifactItems>
                <artifactItem>
                  <groupId>org.keycloak.testsuite</groupId>
                  <artifactId>integration-arquillian-testsuite-providers</artifactId>
                  <version>${project.version}</version>
                  <type>jar</type>
                  <overWrite>false</overWrite>
                  <outputDirectory>${auth.server.home}/providers</outputDirectory>
                </artifactItem>
                <artifactItem>
                  <groupId>org.keycloak.testsuite</groupId>
                  <artifactId>integration-arquillian-testsuite-providers-deployment</artifactId>
                  <version>${project.version}</version>
                  <type>jar</type>
                  <overWrite>false</overWrite>
                  <outputDirectory>${auth.server.home}/providers</outputDirectory>
                </artifactItem>
              </artifactItems>
            </configuration>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <artifactId>maven-assembly-plugin</artifactId>
        <executions>
          <execution>
            <id>create-zip</id>
            <goals>
              <goal>single</goal>
            </goals>
            <phase>package</phase>
            <configuration>
              <descriptors>
                <descriptor>assembly.xml</descriptor>
              </descriptors>
              <appendAssemblyId>false</appendAssemblyId>
            </configuration>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-antrun-plugin</artifactId>
        <executions>
          <execution>
            <id>ant-generate-default</id>
            <goals>
              <goal>run</goal>
            </goals>
            <phase>compile</phase>
            <configuration>
              <target>
                <ant antfile="ant/configure.xml" target="config">
                  <property name="auth.server.home">${auth.server.home}</property>
                </ant>
              </target>
            </configuration>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>

  <profiles>
    <profile>
      <id>auth-server-cluster-quarkus</id>
      <properties>
        <auth.server.quarkus.cluster.config>ha</auth.server.quarkus.cluster.config>
      </properties>
    </profile>

    <profile>
      <id>auth-server-fips140-2</id>
      <properties>
        <auth.server.fips.mode>non-strict</auth.server.fips.mode>
      </properties>

      <dependencies>
        <dependency>
          <groupId>org.keycloak</groupId>
          <artifactId>keycloak-crypto-fips1402</artifactId>
        </dependency>
      </dependencies>

      <build>
        <plugins>
          <plugin>
            <artifactId>maven-resources-plugin</artifactId>
            <executions>
              <execution>
                <id>copy-fips-pki-conf</id>
                <goals>
                  <goal>copy-resources</goal>
                </goals>
                <phase>process-resources</phase>
                <configuration>
                  <outputDirectory>${auth.server.home}/conf</outputDirectory>
                  <resources>
                    <resource>
                      <directory>${common.resources}/fips</directory>
                      <includes>
                        <include>**</include>
                      </includes>
                    </resource>
                  </resources>
                  <overwrite>true</overwrite>
                </configuration>
              </execution>
            </executions>
          </plugin>

          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-dependency-plugin</artifactId>
            <executions>
              <execution>
                <id>copy-bcfips-deps</id>
                <goals>
                  <goal>copy-dependencies</goal>
                </goals>
                <phase>generate-resources</phase>
                <configuration>
                  <outputDirectory>${auth.server.home}/providers</outputDirectory>
                  <includeArtifactIds>bc-fips,bctls-fips,bcpkix-fips,bcutil-fips</includeArtifactIds>
                </configuration>
              </execution>
              <execution>
                <id>copy-bcfips-deps-client</id>
                <goals>
                  <goal>copy-dependencies</goal>
                </goals>
                <phase>generate-resources</phase>
                <configuration>
                  <outputDirectory>${auth.server.home}/bin/client/lib</outputDirectory>
                  <includeArtifactIds>bc-fips,bctls-fips,bcutil-fips</includeArtifactIds>
                </configuration>
              </execution>
            </executions>
          </plugin>

        </plugins>
      </build>

    </profile>

    <profile>
      <id>product</id>
      <activation>
        <property>
          <name>product</name>
        </property>
      </activation>
      <build>
        <plugins>
          <plugin>
            <artifactId>maven-dependency-plugin</artifactId>
            <executions>
              <execution>
                <id>includeProprietaryDependencies</id>
                <goals>
                  <goal>copy</goal>
                </goals>
                <phase>generate-resources</phase>
                <configuration>
                  <artifactItems>
                    <artifactItem>
                      <groupId>com.microsoft.sqlserver</groupId>
                      <artifactId>mssql-jdbc</artifactId>
                      <version>${mssql-jdbc.version}</version>
                      <type>jar</type>
                      <outputDirectory>${auth.server.home}/providers</outputDirectory>
                    </artifactItem>
                  </artifactItems>
                </configuration>
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>

    <profile>
      <id>db-aurora-postgres</id>
      <build>
        <plugins>
          <plugin>
            <artifactId>maven-dependency-plugin</artifactId>
            <executions>
              <execution>
                <id>includeProprietaryDependencies</id>
                <goals>
                  <goal>copy</goal>
                </goals>
                <phase>generate-resources</phase>
                <configuration>
                  <artifactItems>
                    <artifactItem>
                      <groupId>software.amazon.jdbc</groupId>
                      <artifactId>aws-advanced-jdbc-wrapper</artifactId>
                      <version>${aws-jdbc-wrapper.version}</version>
                      <type>jar</type>
                      <outputDirectory>${auth.server.home}/providers</outputDirectory>
                    </artifactItem>
                  </artifactItems>
                </configuration>
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>
  </profiles>
</project>
